<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/OSM_maps/style.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

    <!-- User Info Section -->
    <header>
        <h2>Welcome, {{ user.username }}!</h2>
        <p>Last Login: {{ last_login|default:"First login" }}</p>
        <a href="{% url 'logout' %}"><button>Logout</button></a>
    </header>

    <!-- Login History Section -->
    <section>
        <h3>Login History:</h3>
        <ul>
            {% for login_entry in login_history %}
                <li>
                    {{ login_entry.login_timestamp }} 
                    {% if login_entry.ip_address %}
                        (IP: {{ login_entry.ip_address }})
                    {% endif %}
                </li>
            {% empty %}
                <li>No login history yet.</li>
            {% endfor %}
        </ul>
    </section>

    <!-- Search Section -->
    <section>
        <h1>Find Pharmacies in a Location</h1>
        <form id="locationForm">
            <input type="text" id="locationInput" placeholder="Enter location (e.g., Bhopal)" required>
            <button type="submit">Search</button>
        </form>
    </section>

    <!-- Search History Section -->
    <section>
        <h3>Search History:</h3>
        <ul>
            {% for item in search_history %}
                <li>{{ item.query }} - {{ item.timestamp }}</li>
            {% empty %}
                <li>No search history yet.</li>
            {% endfor %}
        </ul>
        <form action="{% url 'clear_search_history' %}" method="post">
            {% csrf_token %}
            <button type="submit">Clear Search History</button>
        </form>
    </section>

    <!-- Map Display -->
    <section>
        <div id="map"></div>
    </section>

    <!-- Pharmacy List -->
    <section>
        <h2>Pharmacies:</h2>
        <ul id="pharmacyList"></ul>
    </section>

    <!-- JavaScript for Map and Search -->
    <script>
        let map = L.map('map').setView([20, 77], 5); // Default map view

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        document.getElementById('locationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let location = document.getElementById('locationInput').value;
            let pharmacyList = document.getElementById('pharmacyList');
            pharmacyList.innerHTML = '';  // Clear previous results

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${location}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        let lat = data[0].lat;
                        let lon = data[0].lon;
                        map.setView([lat, lon], 13);
                        L.marker([lat, lon]).addTo(map).bindPopup(`<b>${location}</b>`).openPopup();

                        // Fetch pharmacies using Overpass API
                        return fetch(`https://overpass-api.de/api/interpreter?data=[out:json];node["amenity"="pharmacy"](around:5000,${lat},${lon});out;`);
                    } else {
                        throw new Error("Location not found");
                    }
                })
                .then(res => res.json())
                .then(osmData => {
                    if (osmData.elements.length === 0) {
                        pharmacyList.innerHTML = "<li>No pharmacies found.</li>";
                    } else {
                        osmData.elements.forEach(pharmacy => {
                            let name = pharmacy.tags.name || "Unnamed Pharmacy";
                            let pLat = pharmacy.lat;
                            let pLon = pharmacy.lon;

                            // Add marker for each pharmacy
                            L.marker([pLat, pLon]).addTo(map).bindPopup(`<b>${name}</b>`);

                            // Add to list
                            let li = document.createElement("li");
                            li.textContent = name;
                            pharmacyList.appendChild(li);
                        });
                    }
                })
                .catch(err => console.error("Error fetching pharmacies:", err));

            // Fetch pharmacies from Django API
            fetch('/api/pharmacies/')
                .then(response => response.json())
                .then(data => {
                    data.pharmacies.forEach(pharmacy => {
                        L.marker([pharmacy.lat, pharmacy.lon]).addTo(map)
                            .bindPopup(`<b>${pharmacy.name}</b><br>${pharmacy.address}`);

                        let li = document.createElement("li");
                        li.textContent = `${pharmacy.name} - ${pharmacy.address}`;
                        pharmacyList.appendChild(li);
                    });
                })
                .catch(error => console.error("Error loading pharmacies from Django:", error));

            // Fetch pharmacy search results from Django
            fetch(`/search/?query=${encodeURIComponent(location)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.pharmacies.length === 0) {
                        alert("No pharmacies found.");
                    } else {
                        data.pharmacies.forEach(pharmacy => {
                            L.marker([pharmacy.lat, pharmacy.lon]).addTo(map)
                                .bindPopup(`<b>${pharmacy.name}</b><br>${pharmacy.address}`);

                            let li = document.createElement("li");
                            li.textContent = `${pharmacy.name} - ${pharmacy.address}`;
                            pharmacyList.appendChild(li);
                        });
                    }
                })
                .catch(error => console.error("Error fetching pharmacies:", error));
        });
    </script>

</body>
</html>
